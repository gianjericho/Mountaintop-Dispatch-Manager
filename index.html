<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLR Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-item { color: #9CA3AF; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-active { color: #2563EB; border-bottom: 3px solid #2563EB; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sticky-date { position: sticky; top: 0; z-index: 10; background: rgba(241, 245, 249, 0.95); backdrop-filter: blur(4px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .clickable-card:active { transform: scale(0.98); }
        .blur-bg { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-slate-100 pb-24">

    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl fade-in">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-satellite-dish text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">SLR</h1>
                <p class="text-sm text-gray-500">Secure Access</p>
            </div>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label><input type="text" id="login-user" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label><input type="password" id="login-pass" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"></div>
                <button onclick="attemptLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg mt-2">Login</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"><i class="fa-solid fa-circle-exclamation mr-1"></i> Invalid Credentials</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-lg font-extrabold text-slate-800 tracking-tight"><i class="fa-solid fa-satellite-dish text-blue-600 mr-2"></i>SLR</h1>
                <div class="flex gap-2">
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-blue-600 p-2"><i class="fa-solid fa-gear text-lg"></i></button>
                    <button onclick="openBulkModal()" class="bg-purple-100 text-purple-600 px-3 py-1 rounded-lg text-sm font-bold hover:bg-purple-200 transition border border-purple-200"><i class="fa-solid fa-list-check mr-1"></i> Bulk</button>
                    <button onclick="openModal()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">+ New</button>
                </div>
            </div>
            <div class="max-w-lg mx-auto px-4 flex mt-1 border-b border-gray-200 bg-white">
                <button onclick="switchTab('active')" id="nav-active" class="flex-1 py-3 text-center text-sm nav-active">Dispatch</button>
                <button onclick="switchTab('history')" id="nav-history" class="flex-1 py-3 text-center text-sm nav-item">History</button>
                <button onclick="switchTab('performance')" id="nav-performance" class="flex-1 py-3 text-center text-sm nav-item">Performance</button>
            </div>
        </div>

        <div class="max-w-lg mx-auto p-4">
            
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-6 flex items-center justify-between">
                <div class="flex items-center text-gray-500">
                    <i class="fa-regular fa-calendar-days mr-2 text-blue-500"></i>
                    <span class="text-xs font-bold uppercase tracking-wider">Filter Date:</span>
                </div>
                <div class="flex items-center gap-2">
                    <input type="date" id="global-date-filter" onchange="render(true)" class="text-sm font-bold text-gray-700 bg-transparent outline-none cursor-pointer">
                    <button onclick="clearDateFilter()" id="clear-date-btn" class="hidden text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 py-1 rounded-full font-bold transition">CLEAR</button>
                </div>
            </div>

            <div id="loading-screen" class="text-center py-10">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500"></i>
                <p class="text-sm text-gray-500 mt-2">Syncing...</p>
            </div>

            <div id="view-performance" class="hidden fade-in space-y-6">
                <div class="flex justify-between items-center" id="perf-preset-container">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">Dashboard</h3>
                    <select id="perf-filter" onchange="render(true)" class="bg-white border border-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-lg outline-none shadow-sm">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div class="bg-slate-800 text-white rounded-2xl p-5 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-blue-500 rounded-full opacity-20 blur-xl"></div>
                    <div class="flex justify-between items-end mb-2">
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Efficiency Score</p><h2 class="text-3xl font-bold" id="global-percent">0%</h2></div>
                        <div class="text-right"><p class="text-sm text-slate-300"><span id="global-done" class="text-white font-bold">0</span> of <span id="global-total">0</span></p></div>
                    </div>
                    <div class="w-full bg-slate-600 rounded-full h-2.5"><div id="global-bar" class="bg-gradient-to-r from-blue-400 to-emerald-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                </div>
                <div><h3 class="text-xs font-bold text-gray-400 uppercase mb-3 px-1">Team Analytics</h3><div id="team-stats-container" class="grid grid-cols-2 gap-3"></div></div>
                <div><h3 class="text-xs font-bold text-gray-400 uppercase mb-3 px-1">Area Analytics</h3><div id="area-stats-container" class="space-y-3"></div></div>
            </div>

            <div id="view-list" class="hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="list-header" class="text-sm font-bold text-gray-500 uppercase">Active Dispatches</h2>
                    <div>
                        <span id="list-count" class="bg-gray-200 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </div>
                </div>
                <div id="card-container" class="space-y-2"></div>
                <button id="show-more-btn" onclick="showMore()" class="hidden w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-500 font-bold rounded-xl mt-4 text-sm transition">
                    Show More Logs
                </button>
                <div id="empty-msg" class="hidden text-center py-16 text-gray-400"><p class="text-sm">No records found for this date.</p></div>
            </div>
        </div>
    </div>

    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800" id="modal-title">New Dispatch</h2><button onclick="toggleModal('form-modal')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button></div>
            <div class="space-y-3">
                <input type="hidden" id="edit-id"> 
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Subscriber Name</label><input type="text" id="input-name" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Area / Location</label><select id="input-area" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white outline-none"></select></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assign Team</label><select id="input-team" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white outline-none"></select></div>
                <button onclick="saveSO()" id="modal-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition mt-2">Confirm Dispatch</button>
            </div>
        </div>
    </div>

    <div id="bulk-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-list-check text-purple-600 mr-2"></i>Bulk Dispatch</h2><button onclick="toggleModal('bulk-modal')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button></div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Area</label><select id="bulk-area" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white outline-none"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Team</label><select id="bulk-team" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white outline-none"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Paste Names (One per line)</label><textarea id="bulk-names" rows="6" placeholder="John Doe&#10;Jane Smith" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none"></textarea></div>
                <button onclick="saveBulkSO()" id="bulk-btn" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700 transition mt-2">Dispatch All</button>
            </div>
        </div>
    </div>

    <div id="team-analytics-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-slate-800 p-6 text-white shrink-0">
                <div class="flex justify-between items-start"><div><p class="text-xs font-bold text-blue-300 uppercase">Team Performance</p><h2 class="text-2xl font-bold" id="team-modal-name">Team Name</h2></div><button onclick="toggleModal('team-analytics-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button></div>
                <div class="mt-4 flex items-end gap-2"><span class="text-4xl font-bold" id="team-modal-percent">0%</span><span class="text-sm text-slate-400 mb-1">Efficiency</span></div>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center"><p class="text-xs text-blue-500 font-bold uppercase">Total Dispatched</p><p class="text-xl font-bold text-blue-700" id="team-modal-total">0</p></div>
                    <div class="bg-green-50 p-3 rounded-xl border border-green-100 text-center"><p class="text-xs text-green-500 font-bold uppercase">Accomplished</p><p class="text-xl font-bold text-green-700" id="team-modal-done">0</p></div>
                </div>
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Top Areas</h4><div id="team-modal-areas" class="space-y-1 mb-4"></div>
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Recent Activity</h4><div id="team-modal-history" class="space-y-2 text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Manage Teams</h2><button onclick="toggleSettings()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button></div>
            <div class="flex gap-2 mb-4"><input type="text" id="new-team-name" placeholder="New Team Name" class="flex-1 border border-gray-300 rounded-lg p-2 text-sm outline-none"><button onclick="addNewTeam()" class="bg-green-500 text-white px-3 py-2 rounded-lg font-bold"><i class="fa-solid fa-plus"></i></button></div>
            <div id="team-list-settings" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOEmUqFvb0RbyjnMb8wJBP-QOU5LgEiS8", 
            authDomain: "slr-tracker.firebaseapp.com",
            projectId: "slr-tracker",
            storageBucket: "slr-tracker.firebasestorage.app",
            messagingSenderId: "484510554672",
            appId: "1:484510554672:web:f0633e079f3a2b9ede2bf5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const soCollection = collection(db, "service_orders");

        let soData = [];
        const AREAS = ["TAGAYTAY", "AMADEO", "MENDEZ", "BAILEN", "MARAGONDON", "ALFONSO", "MAGALLANES", "INDANG"];
        let teams = JSON.parse(localStorage.getItem('slrTeams')) || ["Team Bernie", "Team Randy"]; 
        let currentTab = 'active';
        // ------
        let renderLimit = 50; 
        
        function isDuplicate(nameToCheck, excludeId = null) {
            const today = new Date().toLocaleDateString();
            const normalizedName = nameToCheck.trim().toLowerCase();
            return soData.some(item => {
                if (excludeId && item.id === excludeId) return false;
                return item.name.trim().toLowerCase() === normalizedName && (item.dateAdded === today);
            });
        }

        window.attemptLogin = () => {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if(u === "mountaintop" && p === "mountaintopadmin") { localStorage.setItem('slrLoggedIn', 'true'); showApp(); } 
            else { document.getElementById('login-error').classList.remove('hidden'); }
        };
        window.logout = () => { localStorage.removeItem('slrLoggedIn'); location.reload(); };
        function showApp() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); startFirebaseListener(); }
        if(localStorage.getItem('slrLoggedIn') === 'true') { showApp(); }

        function startFirebaseListener() {
            const q = query(soCollection);
            onSnapshot(q, (snapshot) => {
                soData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('loading-screen').classList.add('hidden');
                if(currentTab !== 'performance') document.getElementById('view-list').classList.remove('hidden');
                render();
            });
        }

        window.switchTab = (tab) => {
            currentTab = tab;
            renderLimit = 50; // Reset limit on tab switch
            ['active', 'history', 'performance'].forEach(t => {
                const el = document.getElementById(`nav-${t}`);
                if(t === tab) { el.classList.remove('nav-item'); el.classList.add('nav-active'); }
                else { el.classList.remove('nav-active'); el.classList.add('nav-item'); }
            });
            const listView = document.getElementById('view-list');
            const perfView = document.getElementById('view-performance');
            if(tab === 'performance') { listView.classList.add('hidden'); perfView.classList.remove('hidden'); } 
            else { perfView.classList.add('hidden'); listView.classList.remove('hidden'); document.getElementById('list-header').innerText = tab === 'active' ? "Active Dispatches" : "Accomplished Logs"; }
            render(true);
        };

        window.clearDateFilter = () => { document.getElementById('global-date-filter').value = ''; render(true); }
        window.showMore = () => { renderLimit += 50; render(false); }

        function isSameDay(d1, d2) {
            if(!d1 || !d2) return false;
            const date1 = new Date(d1); const date2 = new Date(d2);
            return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate();
        }

        window.render = (resetLimit = false) => {
            if(resetLimit) renderLimit = 50;

            const dateInput = document.getElementById('global-date-filter').value;
            const clearBtn = document.getElementById('clear-date-btn');
            
            let selectedDate = null;
            if(dateInput) {
                const parts = dateInput.split('-');
                selectedDate = new Date(parts[0], parts[1] - 1, parts[2]); 
                clearBtn.classList.remove('hidden');
                document.getElementById('perf-preset-container').classList.add('hidden');
            } else {
                clearBtn.classList.add('hidden');
                document.getElementById('perf-preset-container').classList.remove('hidden');
            }

            let filteredData = soData;

            if(selectedDate) {
                filteredData = soData.filter(item => {
                    const checkDate = item.status === 'active' ? item.dateAdded : (item.timestampDone || item.dateDone);
                    return isSameDay(checkDate, selectedDate);
                });
            } else if (currentTab === 'performance') {
                const filterType = document.getElementById('perf-filter').value;
                const now = new Date();
                filteredData = soData.filter(item => {
                    if(filterType === 'all') return true;
                    const d = new Date(item.timestamp || item.dateAdded);
                    if(filterType === 'today') return isSameDay(d, now);
                    if(filterType === 'week') return (now - d) < 7 * 86400000;
                    if(filterType === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    return true;
                });
            }

            // Stats (Based on ALL filtered data, ignoring pagination)
            const stats = { total: filteredData.length, done: 0, teams: {}, areas: {} };
            teams.forEach(t => stats.teams[t] = { total: 0, done: 0 });
            AREAS.forEach(a => stats.areas[a] = { total: 0, done: 0 });

            filteredData.forEach(item => {
                if(item.status === 'done') stats.done++;
                if(!stats.teams[item.team]) stats.teams[item.team] = { total: 0, done: 0 };
                if(!stats.areas[item.area]) stats.areas[item.area] = { total: 0, done: 0 };
                stats.teams[item.team].total++;
                if(item.status === 'done') stats.teams[item.team].done++;
                stats.areas[item.area].total++;
                if(item.status === 'done') stats.areas[item.area].done++;
            });

            // Update Performance UI
            if(currentTab === 'performance') {
                const globalPercent = stats.total === 0 ? 0 : Math.round((stats.done / stats.total) * 100);
                document.getElementById('global-percent').innerText = globalPercent + '%';
                document.getElementById('global-done').innerText = stats.done;
                document.getElementById('global-total').innerText = stats.total;
                document.getElementById('global-bar').style.width = globalPercent + '%';
                document.getElementById('team-stats-container').innerHTML = Object.entries(stats.teams).filter(([_,d])=>d.total>0).map(([n,d]) => renderMiniCard(n,d.done,d.total)).join('');
                document.getElementById('area-stats-container').innerHTML = Object.entries(stats.areas).filter(([_,d])=>d.total>0).map(([n,d]) => renderAreaRow(n,d.done,d.total)).join('');
                return;
            }

            // RENDER LIST (BATCH + PAGINATION)
            const container = document.getElementById('card-container');
            
            let listItems = [];
            if (currentTab === 'active') listItems = filteredData.filter(i => i.status === 'active');
            else listItems = filteredData.filter(i => i.status === 'done');
            
            document.getElementById('list-count').innerText = listItems.length;
            document.getElementById('empty-msg').className = listItems.length === 0 ? "text-center py-16 text-gray-400" : "hidden";

            // Grouping Logic
            const groups = {};
            listItems.forEach(item => {
                const dateKey = currentTab === 'active' ? item.dateAdded : item.dateDone; 
                const safeDate = dateKey || "Unknown Date"; 
                if(!groups[safeDate]) groups[safeDate] = [];
                groups[safeDate].push(item);
            });
            const sortedDates = Object.keys(groups).sort((a,b) => new Date(b) - new Date(a));

            // Flatten for pagination
            let visibleCards = 0;
            let htmlBuffer = ''; // Build HTML string instead of DOM manipulation

            for(const date of sortedDates) {
                // Header
                htmlBuffer += `<div class="sticky-date py-2 px-1 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase flex justify-between items-center mt-4"><span><i class="fa-regular fa-calendar mr-1"></i> ${date}</span><span class="bg-gray-200 text-gray-600 px-2 rounded-full text-[10px]">${groups[date].length}</span></div>`;
                
                // Cards
                for(const item of groups[date]) {
                    if(visibleCards >= renderLimit) break; // Stop loop if limit reached
                    
                    const isDone = item.status === 'done';
                    const actionHTML = isDone ? `<button onclick="markDone('${item.id}')" class="hidden"></button>` : `<button onclick="markDone('${item.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow uppercase tracking-wide transition flex items-center"><i class="fa-solid fa-check mr-1"></i> Done</button>`;
                    
                    htmlBuffer += `
                    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 ${item.team && item.team.includes('Bernie') ? 'border-orange-400' : 'border-blue-500'} fade-in mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <div><span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block border border-slate-200">${item.area}</span>
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.name}</h3><p class="text-xs text-gray-500 font-bold mt-0.5 uppercase tracking-wide">${item.team}</p></div>
                            <div class="flex gap-1"><button onclick="openModal('${item.id}')" class="text-gray-300 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button><button onclick="deleteSO('${item.id}')" class="text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-3 text-sm text-gray-600 bg-gray-50 p-2 rounded-lg">
                            <label class="flex items-center space-x-2"><input type="checkbox" ${item.checks.pic ? 'checked' : ''} onclick="toggleCheck('${item.id}', 'pic')" ${isDone ? 'disabled' : ''} class="accent-blue-600"><span>Trouble Pic</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" ${item.checks.pwr ? 'checked' : ''} onclick="toggleCheck('${item.id}', 'pwr')" ${isDone ? 'disabled' : ''} class="accent-blue-600"><span>Optical Pwr</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" ${item.checks.speed ? 'checked' : ''} onclick="toggleCheck('${item.id}', 'speed')" ${isDone ? 'disabled' : ''} class="accent-blue-600"><span>Speedtest</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" ${item.checks.rpt ? 'checked' : ''} onclick="toggleCheck('${item.id}', 'rpt')" ${isDone ? 'disabled' : ''} class="accent-blue-600"><span>Service Rpt</span></label>
                        </div>
                        <div class="flex items-center justify-between gap-3"><input type="text" id="rem-${item.id}" value="${item.remarks}" ${isDone ? 'readonly' : ''} placeholder="Remarks..." class="flex-1 bg-white text-sm px-3 py-2 rounded border border-gray-200 focus:outline-none focus:border-blue-500">${actionHTML}</div>
                    </div>`;
                    
                    visibleCards++;
                }
                if(visibleCards >= renderLimit) break;
            }

            // INJECT HTML ONCE (Performance Boost)
            container.innerHTML = htmlBuffer;

            // Handle Show More Button
            if (listItems.length > renderLimit) {
                document.getElementById('show-more-btn').classList.remove('hidden');
                document.getElementById('show-more-btn').innerText = `Show More (${listItems.length - renderLimit} remaining)`;
            } else {
                document.getElementById('show-more-btn').classList.add('hidden');
            }
        }

        // --- STANDARD MODALS (Unchanged) ---
        window.openBulkModal = () => { document.getElementById('bulk-team').innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join(''); document.getElementById('bulk-area').innerHTML = AREAS.map(a => `<option value="${a}">${a}</option>`).join(''); document.getElementById('bulk-names').value = ''; document.getElementById('bulk-btn').innerText = 'Dispatch All'; toggleModal('bulk-modal'); }
        window.saveBulkSO = async () => {
            const rawText = document.getElementById('bulk-names').value;
            const team = document.getElementById('bulk-team').value;
            const area = document.getElementById('bulk-area').value;
            const names = rawText.split(/\r?\n/).map(n => n.trim()).filter(n => n.length > 0);
            if(names.length === 0) return alert("Please enter at least one name.");
            const duplicates = names.filter(n => isDuplicate(n));
            if (duplicates.length > 0) return alert(`DUPLICATES:\n- ${duplicates.join('\n- ')}`);
            document.getElementById('bulk-btn').innerText = `Processing...`;
            document.getElementById('bulk-btn').disabled = true;
            try { await Promise.all(names.map(name => addDoc(soCollection, { name, team, area, status: 'active', dateAdded: new Date().toLocaleDateString(), timestamp: Date.now(), dateDone: null, checks: { pic: false, pwr: false, speed: false, rpt: false }, remarks: '' }))); toggleModal('bulk-modal'); } 
            catch (e) { alert("Error: " + e.message); } finally { document.getElementById('bulk-btn').disabled = false; }
        }
        window.saveSO = async () => {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('input-name').value;
            const team = document.getElementById('input-team').value;
            const area = document.getElementById('input-area').value;
            if(!name) return alert("Name required");
            if(isDuplicate(name, id)) return alert(`DUPLICATE: "${name}"`);
            try {
                if(id) await updateDoc(doc(db, "service_orders", id), { name, team, area });
                else await addDoc(soCollection, { name, team, area, status: 'active', dateAdded: new Date().toLocaleDateString(), timestamp: Date.now(), dateDone: null, checks: { pic: false, pwr: false, speed: false, rpt: false }, remarks: '' });
                toggleModal('form-modal');
            } catch (e) { alert(e.message); }
        };
        window.openTeamAnalytics = (teamName) => {
            const dateInput = document.getElementById('global-date-filter').value;
            let selectedDate = null;
            if(dateInput) { const parts = dateInput.split('-'); selectedDate = new Date(parts[0], parts[1] - 1, parts[2]); }
            let teamData = soData.filter(i => i.team === teamName);
            if(selectedDate) { teamData = teamData.filter(item => { const itemDate = new Date(item.status === 'active' ? (item.timestamp || item.dateAdded) : (item.timestampDone || item.dateDone)); return isSameDay(itemDate, selectedDate); }); }
            const doneData = teamData.filter(i => i.status === 'done');
            const total = teamData.length; const done = doneData.length; const percent = total === 0 ? 0 : Math.round((done / total) * 100);
            const areaCounts = {}; teamData.forEach(item => { areaCounts[item.area] = (areaCounts[item.area] || 0) + 1; });
            const sortedAreas = Object.entries(areaCounts).sort((a,b) => b[1] - a[1]).slice(0, 3);
            document.getElementById('team-modal-name').innerText = teamName;
            document.getElementById('team-modal-percent').innerText = percent + "%";
            document.getElementById('team-modal-total').innerText = total;
            document.getElementById('team-modal-done').innerText = done;
            const areaContainer = document.getElementById('team-modal-areas');
            areaContainer.innerHTML = sortedAreas.length === 0 ? '<p class="text-xs text-gray-400 italic">No data</p>' : sortedAreas.map(([area, count]) => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-xs"><span class="font-bold text-gray-600">${area}</span><span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">${count}</span></div>`).join('');
            const historyContainer = document.getElementById('team-modal-history');
            const history = teamData.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).slice(0, 5);
            historyContainer.innerHTML = history.length === 0 ? '<p class="text-xs text-gray-400 italic">No history</p>' : history.map(item => { const icon = item.status === 'done' ? '<i class="fa-solid fa-check text-green-500"></i>' : '<i class="fa-regular fa-clock text-orange-400"></i>'; return `<div class="flex justify-between items-center border-b border-gray-100 py-2 last:border-0"><div><p class="font-bold text-gray-700 truncate w-40">${item.name}</p><p class="text-[10px] text-gray-400">${item.dateAdded}</p></div>${icon}</div>`; }).join('');
            toggleModal('team-analytics-modal');
        };
        window.openModal = (editId = null) => { const teamSel = document.getElementById('input-team'); const areaSel = document.getElementById('input-area'); teamSel.innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join(''); areaSel.innerHTML = AREAS.map(a => `<option value="${a}">${a}</option>`).join(''); if(editId) { const item = soData.find(i => i.id === editId); document.getElementById('modal-title').innerText = "Edit Details"; document.getElementById('modal-btn').innerText = "Save Changes"; document.getElementById('edit-id').value = editId; document.getElementById('input-name').value = item.name; teamSel.value = item.team; areaSel.value = item.area; } else { document.getElementById('modal-title').innerText = "New Dispatch"; document.getElementById('modal-btn').innerText = "Confirm Dispatch"; document.getElementById('edit-id').value = ""; document.getElementById('input-name').value = ""; } toggleModal('form-modal'); }
        window.deleteSO = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "service_orders", id)); }
        window.markDone = async (id) => { const so = soData.find(i => i.id === id); const rem = document.getElementById(`rem-${id}`).value || so.remarks; await updateDoc(doc(db, "service_orders", id), { status: 'done', remarks: rem, dateDone: new Date().toLocaleDateString(), timestampDone: Date.now() }); };
        window.toggleCheck = async (id, key) => { const so = soData.find(i => i.id === id); const c = { ...so.checks }; c[key] = !c[key]; await updateDoc(doc(db, "service_orders", id), { checks: c }); };
        window.toggleModal = (id) => { const m = document.getElementById(id); m.classList.contains('hidden') ? (m.classList.remove('hidden'), m.classList.add('flex')) : (m.classList.add('hidden'), m.classList.remove('flex')); }
        window.toggleSettings = () => { toggleModal('settings-modal'); document.getElementById('team-list-settings').innerHTML = teams.map(t => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200"><span class="text-sm font-medium text-gray-700">${t}</span><button onclick="removeTeam('${t}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button></div>`).join(''); }
        window.addNewTeam = () => { const val = document.getElementById('new-team-name').value.trim(); if (val && !teams.includes(val)) { teams.push(val); localStorage.setItem('slrTeams', JSON.stringify(teams)); toggleSettings(); } }
        window.removeTeam = (val) => { if(confirm('Delete?')) { teams = teams.filter(t=>t!==val); localStorage.setItem('slrTeams', JSON.stringify(teams)); toggleSettings(); } }
        function renderMiniCard(t,d,tot) { const p = tot===0?0:Math.round((d/tot)*100); const c = p===100?'text-green-600':(p>50?'text-blue-600':'text-orange-500'); return `<div onclick="openTeamAnalytics('${t}')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 cursor-pointer clickable-card hover:border-blue-300 transition select-none"><div class="flex justify-between items-center mb-1"><h4 class="text-xs font-bold text-gray-500 uppercase truncate w-24">${t}</h4><span class="${c} font-bold text-sm">${p}%</span></div><div class="w-full bg-gray-100 rounded-full h-1.5 mb-1"><div class="bg-slate-800 h-1.5 rounded-full" style="width: ${p}%"></div></div><p class="text-xs text-gray-400 text-right">${d}/${tot}</p></div>`; }
        function renderAreaRow(t,d,tot) { const p = tot===0?0:Math.round((d/tot)*100); return `<div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-100"><span class="text-xs font-bold text-gray-700 w-1/3">${t}</span><div class="w-1/3 px-2"><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${p}%"></div></div></div><div class="w-1/3 text-right"><span class="text-xs font-bold text-gray-600">${p}%</span><span class="text-[10px] text-gray-400 ml-1">(${d}/${tot})</span></div></div>`; }
        // --- TEMPORARY EXPORT TOOL ---
        window.exportToCSV = () => {
            if(!soData || soData.length === 0) return alert("No data to export!");
            
            // Define headers
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "id,name,area,team,status,dateAdded,dateDone,remarks,pic,pwr,speed,rpt\n"; // Header row

            // Loop through data and format as CSV line
            soData.forEach(item => {
                // Flatten the 'checks' object into individual columns
                const pic = item.checks ? item.checks.pic : false;
                const pwr = item.checks ? item.checks.pwr : false;
                const speed = item.checks ? item.checks.speed : false;
                const rpt = item.checks ? item.checks.rpt : false;

                // Clean text to avoid CSV errors (remove commas in names/remarks)
                const cleanName = (item.name || "").replace(/,/g, " ");
                const cleanRem = (item.remarks || "").replace(/,/g, " ");
                
                let row = `${item.id},${cleanName},${item.area},${item.team},${item.status},${item.dateAdded},${item.dateDone || ""},${cleanRem},${pic},${pwr},${speed},${rpt}`;
                csvContent += row + "\n";
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "SLR_Backup_Data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>